---
title: "SCT Task 2"
author: "Michael Bohl"
date: "2024-04-24"
output: html_document
---

## IMPORTS, install libraries if needed
```{r}
required_libraries = c("BiocManager", "R.utils", "Seurat", "Matrix", "dplyr", "patchwork", "devtools", "simspec", "ggplot2", "ggrepel", "DESeq2", "scran", "pbapply", "presto")

# load libraries and install from CRAN if necessary
for (library_name in required_libraries) {
  if (!requireNamespace(library_name, quietly = TRUE)) {
    message(paste("Installing and loading library", library_name))
    install.packages(library_name)
  }
  library(library_name, character.only = TRUE)
}

# libraries that are not available from CRAN
# BiocManager::install("Seurat")
# BiocManager::install("DESeq2")
# BiocManager::install("scran")
# devtools::install_github("immunogenomics/presto")
# devtools::install_github('quadbio/simspec')

```

### Part 1. Descriptive analysis of the data set


## read in the data (rename the counts file to matrix.mtx.gtz)
```{r}
counts <- Read10X("./data", gene.column=1)
meta <- read.table("./data/meta.tsv.gz")
seurat <- CreateSeuratObject(counts, meta.data = meta)
```


## routine processing
```{r}
# Normalize, find variable features, remove cell cycle genes, and scale data
seurat <- NormalizeData(seurat) %>%
  FindVariableFeatures(nfeatures = 3000) %>%
  CellCycleScoring(s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes)
VariableFeatures(seurat) <- setdiff(VariableFeatures(seurat), c(unlist(cc.genes.updated.2019), grep("^MT-", rownames(seurat), value=T))) # remove cell cycle genes and mitochondrial genes

seurat <- ScaleData(seurat, vars.to.regress = c("G2M.Score","S.Score")) %>% # regress out cell cycle scores
  RunPCA(npcs = 20) %>% #10 PCAs as in the paper
  RunUMAP(dims = 1:10, min.dist = 0.5, spread = 0.5)

plot1 <- UMAPPlot(seurat, group.by="organoid") & NoAxes()
plot2 <- FeaturePlot(seurat, c("FOXG1","EMX1","DLX2","MKI67"), order=T) & NoAxes() & NoLegend()
plot1 | plot2
```  


## CSS integration
```{r}
seurat <- cluster_sim_spectrum(seurat, label_tag = "organoid", cluster_resolution = 1)
seurat <- RunUMAP(seurat, reduction = "css", dims = 1:ncol(Embeddings(seurat,"css")), reduction.name = "umap_css", reduction.key = "UMAPCSS_")
plot1 <- DimPlot(seurat, reduction = "umap_css", group.by="GLI3_status") & NoAxes()
plot1 <- DimPlot(seurat, reduction = "umap_css", group.by="organoid") & NoAxes()
plot2 <- FeaturePlot(seurat, c("FOXG1","EMX1","DLX2","MKI67"), reduction = "umap_css", order=T) & NoAxes() & NoLegend()
plot1 | plot2
```

  

## Cluster and annotate data
```{r}
seurat <- FindNeighbors(seurat, reduction = "css", dims = 1:ncol(Embeddings(seurat,"css"))) %>%
  FindClusters(resolution = 0.9)

plot1 <- DimPlot(seurat, reduction = "umap_css", label = T) & NoAxes()
plot2 <- FeaturePlot(seurat, c("SOX2","DCX","FOXG1","EMX1","DLX2","MKI67","OTX2","HOXB2","TTR"),
                     reduction = "umap_css", order=T) & NoAxes() & NoLegend()
plot1 | plot2

# TODO: annotate clusters, this is too inaccurate
seurat@meta.data$region <- factor(setNames(c("ventral telen.",
                                   "ventral telen.",
                                   "non-telen.",
                                   "dorsal telen.",
                                   "non-telen.",
                                   "non-telen.",
                                   "non-telen.",
                                   "ventral telen.",
                                   "non-telen.",
                                   "dorsal telen.",
                                   "non-telen.",
                                   "ventral telen.",
                                   "non-telen.",
                                   "non-telen.",
                                   "non-telen.",
                                   "mixed",
                                   "dorsal telen.",
                                   "non-telen.",
                                   "dorsal telen.",
                                   "non-telen.",
                                   "dorsal telen.",
                                   "dorsal telen."),
                                 levels(seurat@active.ident))[seurat@active.ident],
                        levels=c("dorsal telen.","ventral telen.","non-telen.","mixed"))
plot1 <- DimPlot(seurat, reduction = "umap_css", group.by = "region") & NoAxes()
plot2 <- FeaturePlot(seurat, c("SOX2","DCX","FOXG1","EMX1","DLX2","MKI67","OTX2","HOXB2","TTR"), reduction = "umap_css", order=T) & NoAxes() & NoLegend()
plot1 | plot2
```

### Part 2. Comparison of cell type compositions between conditions

## visually check cell type compositions
```{r}
freq <- table(seurat@meta.data$region, seurat$organoid) # create a frequency table of annotated cell types
prop <- apply(freq,2,function(x) x/sum(x)) # calculate the proportion of each cell type

layout(matrix(1:3,nrow=1)); par(mar=c(8,5,1,1)) # set the layout for the plots
barplot(freq, col=c("#E74C3C","#A569BD","#76D7C4","#CCD1D1"),
        border=NA, las=2, ylab="Frequency", cex.names = 0.8)
barplot(prop, col=c("#E74C3C","#A569BD","#76D7C4","#CCD1D1"),
        border=NA, las=2, ylab="Proportion", cex.names = 0.8)
plot.new()
legend("left", fill=c("#E74C3C","#A569BD","#76D7C4","#CCD1D1"), legend=rownames(freq), bty="n")

```
# visible difference between WT and KO: ... (fix once clusters are annotated)


## compare cells using Fisher's exact test
```{r}
freq_fisher <- function(conditions, have_identity){
  freq <- table(factor(have_identity, levels=c(TRUE,FALSE)),
                conditions)
  test <- fisher.test(freq)
  res <- setNames(c(test$estimate, test$p.value), c("oddsratio","pval_fisher"))
  return(res)
}

region_enrichment <- data.frame(region = levels(seurat@meta.data$region),
                                # loop and test every region
                                t(sapply(levels(seurat@meta.data$region), function(region)
                                  freq_fisher(conditions = factor(seurat$GLI3_status, levels=c("KO","WT")),
                                              have_identity = seurat@meta.data$region == region)
                                )),
                                row.names=NULL)
region_enrichment$padj_fisher <- p.adjust(region_enrichment$pval_fisher)

region_enrichment
```

## GLM with binomial distribution, followed by ANOVA

```{r}
freq_glm_aov <- function(samples, conditions, have_identity){
  sample_conditions <- unique(data.frame(sample = samples, condition = conditions))
  sample_conditions <- setNames(sample_conditions$condition, sample_conditions$sample)

  freq <- table(samples, factor(have_identity, levels=c(TRUE,FALSE)))
  m <- glm(freq ~ sample_conditions[rownames(freq)], family = "binomial")
  aov <- anova(m, test = "Chisq")
  res <- setNames(c(coef(m)[2], aov$Pr[2]), c("coef_glm","pval_aov"))
  return(res)
}

region_enrichment <- data.frame(region_enrichment,
  # loop and test every region
  t(sapply(levels(seurat$region), function(region){
    freq_glm_aov(samples = seurat$organoid,
                 conditions = factor(seurat$GLI3_status, levels=c("WT","KO")),
                 seurat$region == region)
  })),
  row.names=NULL)
region_enrichment$padj_aov <- p.adjust(region_enrichment$pval_aov)
region_enrichment
```

## differential gene expression analysis: first, measure similarity between the clusters, then do a Wilcoxon test for DE
```{r}
seurat_ventral <- subset(seurat, subset = seurat_clusters == 0) %>%
  FindVariableFeatures()

DE_wilcoxauc_ventral <- wilcoxauc(seurat_ventral, group_by = "GLI3_status") %>%
  filter(group == "KO") %>%
  mutate(DE = abs(logFC)>log(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(abs(logFC)>log(1.1) & padj < 0.01, feature, NA))

# volcano plot

ggplot(DE_wilcoxauc_ventral, aes(x = logFC, y = -log10(padj), col=DE, label=DEG)) +
  geom_point() +
  geom_text_repel() +
  geom_vline(xintercept=c(-log(1.1), log(1.1), 0), col="#303030", linetype="dotted") +
  geom_hline(yintercept=-log10(0.01), col="#303030", linetype="dotted") +
  scale_color_manual(values=c("#909090", "red")) +
  theme_minimal()

```

## Do the same wit DESeq2
```{r}
### test
# Get the counts matrix
counts <- GetAssayData(seurat_ventral, assay = "RNA", slot = "counts")

# Filter genes based on detection rate
det_rate <- rowMeans(counts > 0)
filtered_counts <- counts[det_rate > 0.05, ]

# Add metadata (assuming 'GLI3_status' is in your metadata)
meta <- seurat_ventral@meta.data %>% 
  mutate(GLI3_status = factor(GLI3_status, levels=c("WT","KO")))

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = filtered_counts,
                              colData = meta,
                              design = ~ GLI3_status)

# Use the original counts for size factor calculation (not filtered)
all_counts <- GetAssayData(seurat_ventral, assay = "RNA", slot = "counts")
sizeFactors(dds) <- calculateSumFactors(all_counts)  

# DESeq analysis
dds <- DESeq(dds, test="LRT", reduced=~1, useT=TRUE, minmu=1e-6, minReplicatesForReplace=Inf)

# Results and filtering
DE_deseq2_ventral <- results(dds) %>% 
  as.data.frame() %>%
  tibble::rownames_to_column("gene") %>%
  mutate(DE = abs(log2FoldChange) > log2(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(DE, gene, NA))  # Simplified DEG calculation
###

det_rate <- rowMeans(seurat_ventral@assays$RNA$data)
meta <- seurat_ventral@meta.data %>% mutate(GLI3_status = factor(GLI3_status, levels=c("WT","KO")))
dds <- DESeqDataSetFromMatrix(seurat_ventral@assays$RNA@data[det_rate > 0.05,],
                              colData=meta,
                              design = ~ GLI3_status)
sizeFactors(dds) <- calculateSumFactors(seurat_ventral@assays$RNA@counts[det_rate > 0.05,])
dds <- DESeq(dds, test="LRT", reduced=~1, useT=TRUE, minmu=1e-6, minReplicatesForReplace=Inf)
DE_deseq2_ventral <- results(dds) %>% as.data.frame() %>%
  tibble::rownames_to_column("gene") %>%
  mutate(DE = abs(log2FoldChange)>log2(1.1) & padj < 0.01) %>%
  mutate(DEG = ifelse(abs(log2FoldChange)>log2(1.1) & padj < 0.01, gene, NA))
  
```

## Part 3

```{r}
seurat_ventral <- subset(seurat, subset = seurat_clusters == 4) %>%
  FindVariableFeatures()

# Use DefaultAssay to specify the assay
DefaultAssay(seurat_ventral) <- "RNA" 

# Calculate average expression for each organoid
avg_expr_org <- AverageExpression(seurat_ventral, assays = "RNA", slot = "data", group.by = "organoid")

# Convert to a matrix for further analysis
avg_expr_org_matrix <- as.matrix(avg_expr_org[["RNA"]])

# Filter to variable features
avg_expr_org_filtered <- avg_expr_org_matrix[VariableFeatures(seurat_ventral),]

# Remaining code (correlation and plotting) should work as before
corr_org <- cor(avg_expr_org_matrix, method = "spearman")
plot(hclust(as.dist(1-corr_org)))
``` 




